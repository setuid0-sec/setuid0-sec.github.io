<html>

	<head>
		<link rel="shortcut icon" href="../favicon.ico">
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css" integrity="sha512-8bHTC73gkZ7rZ7vpqUQThUDhqcNFyYi2xgDgPDHc+GXVGHXq+xPjynxIopALmOPqzo9JZj0k6OqqewdGO3EsrQ==" crossorigin="anonymous" />
		<script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.js" integrity="sha512-dqw6X88iGgZlTsONxZK9ePmJEFrmHwpuMrsUChjAw1mRUhUITE5QU9pkcSox+ynfLhL15Sv2al5A0LVyDCmtUw==" crossorigin="anonymous"></script>

		<link rel="stylesheet" href="../style.css">
	</head>

	<body>

	<div class="ui inverted menu">
		<a class="item" href="../index.html"> <i class="home icon"></i> Home </a>
		<a class="active item" href="../research.html"> <i class="bug icon"></i> Research Publications</a>
		<a class="item" href="../about.html"> <i class="user secret icon"></i> Whoami </a>
	</div>
	
	
	<div id="releases">
	<table>
	<th>ID</th>
	<th>Product</th>
	<th>Version</th>
	<th>Vulnerability</th>
	<tr>
	<td>CVE-2019-25022</td>
	<td>Scytl Secure Vote (sVote)</td>
	<td>2.1</td>
	<td>SDM RCE</td>
	</tr>
	</table>
	
	<h1>Description</h1>
	
	
	<b>Root-Cause:</b></br>
	
	File: <i>evoting-solution/source-code/online-voting-secure-data-manager/secure-data-manager-backend/secure-data-manager-integration/src/main/java/com/scytl/products/ov/sdm/plugin/SequentialExecutorImpl.java</i></br></br>
	Contains the following function:
	<code>public void execute(List<String> commands, Parameters parameters, ExecutionListener listener) {

       for(String command : commands) {
           String mockCommand = command;
           try {
               //Replace the parameters and execute the command
               String[] partialCommands = replaceParameters(command, parameters);
               String fullCommand = partialCommands[0];
               mockCommand = partialCommands[1];
               Process proc = Runtime.getRuntime().exec(fullCommand);
	</code>
	
	
	
	The mentioned replace function doesn't do anything security wise:
	<code>private String[] replaceParameters(String command, Parameters parameters) {
       String partialCommand = command;
       String replacedCommand = command;
       
       for (KeyParameter key : KeyParameter.values()) {
           if(replacedCommand.contains(key.toString())) {
               String value = parameters.getParam(key.name());
               if(value == null || value.isEmpty()){
                   throw new IllegalArgumentException("Parameter #" + key.name() + "# is null or empty");
               } else {
               	replacedCommand = replacedCommand.replaceAll("#" + key + "#", value);
                   if (key == KeyParameter.PRIVATE_KEY) {
                       partialCommand = partialCommand.replaceAll("#" + key + "#", "PRIVATE_KEY");
                   } else {
                       partialCommand = partialCommand.replaceAll("#" + key + "#", value);
                   }
               }
	</code>

		
	
	<b>Trigger:</b></br>
		
	File: <i>/secure-data-manager-backend/sdm-ws-rest/src/main/java/com/scytl/products/ov/sdm/ui/ws/rs/application/OperationsResource.java</i></br></br>
	The vulnerability can be triggered from the ws-rest backend (api):
	
	<code>@RequestMapping(value = "/generate-ea-structure/{electionEventId}", method = RequestMethod.POST)
    @ApiOperation(value = "Export operation service", notes = "", response = Void.class)
    @ApiResponses(value = {@ApiResponse(code = 404, message = "Not Found"),
            @ApiResponse(code = 403, message = "Forbidden"),
            @ApiResponse(code = 500, message = "Internal Server Error") })
    public ResponseEntity<OperationResult> extendedAuthenticationMappingDataOperation(
            @ApiParam(value = "String", required = true) @PathVariable String electionEventId,
            @RequestBody final OperationsData request) {
        Parameters parameters = buildParameters(electionEventId, request.getPrivateKeyInBase64(), null);
        return executeOperationForPhase(parameters, PhaseName.PREPARE_VC_GENERATION, true, null, null);
    }
	</code>
	
	The electionEventId is declared as a string instead of an id without validation which allows us to pass arbitrary data:
	<code>@ApiParam(value = "String", required = true) @PathVariable String electionEventId,</code></br>
	
	Then buildParameters() is called:
	<code>private Parameters buildParameters(String electionEventId, String privateKeyInBase64, String path) {
        Parameters parameters = new Parameters();

        if (StringUtils.isNotEmpty(electionEventId)) {
            String electionEventAlias = electionEventService.getElectionEventAlias(electionEventId);
            parameters.addParam(KeyParameter.EE_ALIAS.name(), electionEventAlias);
            parameters.addParam(KeyParameter.EE_ID.name(), electionEventId);
        }
        Path sdmPath = pathResolver.resolve(ConfigConstants.SDM_DIR_NAME);
        parameters.addParam(KeyParameter.SDM_PATH.name(), sdmPath.toString().replace("\\", "/"));
        if (StringUtils.isNotEmpty(privateKeyInBase64)) {
            parameters.addParam(KeyParameter.PRIVATE_KEY.name(), privateKeyInBase64);
        }
        if (StringUtils.isNotEmpty(path)) {
            parameters.addParam(KeyParameter.USB_LETTER.name(), path.replace("\\", "/"));
        }
        return parameters;
    }
	</code>
	
	Which adds two parameters to the list:
	<ul>
	<li>electionEventAlias (retrieved by electionEventService.getElectionEventAlias())</li>
	<li>electionEventId (user controlled!)</li>
	</ul>

	The following method adds parameters to our request: <i>/secure-data-manager-backend/secure-data-manager-services/src/main/java/com/scytl/products/ov/sdm/infrastructure/electionevent/ElectionEventRepositoryImpl.java</i>
	<code>@Override
    public String getElectionEventAlias(final String electionEventId) {
        String sql =
            "select alias from " + entityName() + " where id = :id";
        Map<String, Object> parameters = singletonMap(
            JsonConstants.JSON_ATTRIBUTE_NAME_ID, electionEventId);
        List<ODocument> documents;
        try {
            documents = selectDocuments(sql, parameters, 1);
        } catch (OException e) {
            throw new DatabaseException(
                "Failed to get election event alias.", e);
        }
        return documents.isEmpty() ? ""
                : documents.get(0).field("alias", String.class);
    }	
	</code>

	
	Which leaves us with two values:
	<ul>
	<li>parameters.addParam(KeyParameter.EE_ALIAS.name(), "");</li>
    <li>parameters.addParam(KeyParameter.EE_ID.name(), "evil payload");</li>
	</ul>
	
	That get passed to:
	<code>return executeOperationForPhase(parameters, PhaseName.PREPARE_VC_GENERATION, true, null, null);</code> </br>
	
	Which redirects to sequentialExecutor.execute:
	<code>private ResponseEntity<OperationResult> executeOperationForPhase(Parameters parameters, PhaseName phaseName, boolean failOnEmptyCommandsForPhase, SdmSecureLogEvent secureLogEvent, String electionEventId) {
        try {
            List<String> commandsForPhase = getCommands(phaseName);

            if (failOnEmptyCommandsForPhase && commandsForPhase.isEmpty()) {
                logSecure(secureLogEvent, electionEventId,
                    "The request can not be performed for 4005, Missing commands for phase");

                return handleException(OperationsOutputCode.MISSING_COMMANDS_FOR_PHASE);
            }
            ExecutionListenerImpl listener = new ExecutionListenerImpl();
            sequentialExecutor.execute(commandsForPhase, parameters, listener);
	</code>
	
	Which then executes our command and leaves us with control over the application.
	
	
	<h1>Disclosure Timeline</h1>
	<ul>
	<li> Feb 08, 2019 - Submitted vulnerability to vendor</li>
	<li> Feb 09, 2019 - Submitted additional details to vendor</li>
	<li> Feb 18, 2019 - Vendor acknowledged the vulnerability</li>
	</ul>
	<h1>Credit</h1>
	<p>Jannis Kirschner & Anthony Schneiter from Team SUID</p>
	</div>

	</body>
</html>