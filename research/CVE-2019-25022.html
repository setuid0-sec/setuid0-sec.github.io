<html>
    <head>
        <title>setuid(0); Research Team</title>
        <link rel="icon" type="image/png" href="/static/img/favicon.png" sizes="32x32">

        <script src="/static/js/jquery-3.6.0.min.js"></script>

        <link href="/static/semantic/semantic.min.css" rel="stylesheet" />
        <link href="/static/css/halfmoon-variables.min.css" rel="stylesheet" />

        <script src="/static/semantic/semantic.min.js"></script>   


        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/base16/dracula.min.css">
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.min.js"></script>
        
        <link href="/static/css/suid.css" rel="stylesheet" />
    </head>

    <body>
        <div class="page-wrapper with-navbar-fixed-bottom">
            <div class="content-wrapper">
                <nav class="navbar">

                    <a href="/home.html" class="navbar-brand">
                        setuid(0);
                    </a>

                    <ul class="navbar-nav d-none d-md-flex"> 
                        <li class="nav-item">
                            <a href="/research.html" class="nav-link">
                                <button class="btn alt-dm active" type="button" style="color:#0FFFFF;">Research</button>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="/art.html" class="nav-link">
                                <button class="btn alt-dm active" type="button" style="color:#FF1493;">Art</button>
                            </a>
                        </li>
                    </ul>

                </nav>

                <div id="pageContent" class="container-fluid">
                    
<div class="w-1000 mw-full">
    <div class="card p-0 bg-very-dark-dm"> 
        <div class="table-responsive">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        
                        <td><b>ID</b></td>
                        
                        <td><b>Product</b></td>
                        
                        <td><b>Version</b></td>
                        
                        <td><b>Vulnerability</b></td>
                        
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        
                        <td>
                            CVE-2019-25022
                        </td>
                        
                        <td>
                            Scytl Secure Vote (sVote)
                        </td>
                        
                        <td>
                            2.1
                        </td>
                        
                        <td>
                            SDM RCE
                        </td>
                        
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>



<div style="margin-left:30px;">
    

    <h1>Description</h1>
	

<b>Root-Cause:</b><br />

File: 
<pre><code class="language-plaintext">evoting-solution/source-code/online-voting-secure-data-manager/secure-data-manager-backend/secure-data-manager-integration/src/main/java/com/scytl/products/ov/sdm/plugin/SequentialExecutorImpl.java</code></pre>

<br />
<br />

Contains the following function:
<pre><code class="language-java">public void execute(List<String> commands, Parameters parameters, ExecutionListener listener) {

    for(String command : commands) {
        String mockCommand = command;
        try {
            //Replace the parameters and execute the command
            String[] partialCommands = replaceParameters(command, parameters);
            String fullCommand = partialCommands[0];
            mockCommand = partialCommands[1];
            Process proc = Runtime.getRuntime().exec(fullCommand);
</code></pre>



The mentioned replace function doesn't do anything security wise:
<pre><code class="language-java">private String[] replaceParameters(String command, Parameters parameters) {
    String partialCommand = command;
    String replacedCommand = command;
    
    for (KeyParameter key : KeyParameter.values()) {
        if(replacedCommand.contains(key.toString())) {
            String value = parameters.getParam(key.name());
            if(value == null || value.isEmpty()){
                throw new IllegalArgumentException("Parameter #" + key.name() + "# is null or empty");
            } else {
            replacedCommand = replacedCommand.replaceAll("#" + key + "#", value);
                if (key == KeyParameter.PRIVATE_KEY) {
                    partialCommand = partialCommand.replaceAll("#" + key + "#", "PRIVATE_KEY");
                } else {
                    partialCommand = partialCommand.replaceAll("#" + key + "#", value);
                }
            }
</code></pre>

    

<b>Trigger:</b>
<br />
    
File:
<pre><code class="language-plaintext">/secure-data-manager-backend/sdm-ws-rest/src/main/java/com/scytl/products/ov/sdm/ui/ws/rs/application/OperationsResource.java</code></pre>
<br />
<br />
The vulnerability can be triggered from the ws-rest backend (api):

<pre><code class="language-java">@RequestMapping(value = "/generate-ea-structure/{electionEventId}", method = RequestMethod.POST)
@ApiOperation(value = "Export operation service", notes = "", response = Void.class)
@ApiResponses(value = {@ApiResponse(code = 404, message = "Not Found"),
        @ApiResponse(code = 403, message = "Forbidden"),
        @ApiResponse(code = 500, message = "Internal Server Error") })
public ResponseEntity<OperationResult> extendedAuthenticationMappingDataOperation(
        @ApiParam(value = "String", required = true) @PathVariable String electionEventId,
        @RequestBody final OperationsData request) {
    Parameters parameters = buildParameters(electionEventId, request.getPrivateKeyInBase64(), null);
    return executeOperationForPhase(parameters, PhaseName.PREPARE_VC_GENERATION, true, null, null);
}
</code></pre>

The electionEventId is declared as a string instead of an id without validation which allows us to pass arbitrary data:

<pre><code class="language-java">@ApiParam(value = "String", required = true) @PathVariable String electionEventId,</code></pre>
<br />

Then buildParameters() is called:
<pre><code class="language-java">private Parameters buildParameters(String electionEventId, String privateKeyInBase64, String path) {
    Parameters parameters = new Parameters();

    if (StringUtils.isNotEmpty(electionEventId)) {
        String electionEventAlias = electionEventService.getElectionEventAlias(electionEventId);
        parameters.addParam(KeyParameter.EE_ALIAS.name(), electionEventAlias);
        parameters.addParam(KeyParameter.EE_ID.name(), electionEventId);
    }
    Path sdmPath = pathResolver.resolve(ConfigConstants.SDM_DIR_NAME);
    parameters.addParam(KeyParameter.SDM_PATH.name(), sdmPath.toString().replace("\\", "/"));
    if (StringUtils.isNotEmpty(privateKeyInBase64)) {
        parameters.addParam(KeyParameter.PRIVATE_KEY.name(), privateKeyInBase64);
    }
    if (StringUtils.isNotEmpty(path)) {
        parameters.addParam(KeyParameter.USB_LETTER.name(), path.replace("\\", "/"));
    }
    return parameters;
}
</code></pre>

Which adds two parameters to the list:
<pre><code class="language-plaintext">- electionEventAlias (retrieved by electionEventService.getElectionEventAlias())
- electionEventId (user controlled!)
</code></pre>

The following method adds parameters to our request: 
<pre><code class="language-java">/secure-data-manager-backend/secure-data-manager-services/src/main/java/com/scytl/products/ov/sdm/infrastructure/electionevent/ElectionEventRepositoryImpl.java</code></pre>
<pre><code class="language-java">@Override
public String getElectionEventAlias(final String electionEventId) {
    String sql =
        "select alias from " + entityName() + " where id = :id";
    Map<String, Object> parameters = singletonMap(
        JsonConstants.JSON_ATTRIBUTE_NAME_ID, electionEventId);
    List<ODocument> documents;
    try {
        documents = selectDocuments(sql, parameters, 1);
    } catch (OException e) {
        throw new DatabaseException(
            "Failed to get election event alias.", e);
    }
    return documents.isEmpty() ? ""
            : documents.get(0).field("alias", String.class);
}	
</code></pre>


Which leaves us with two values:
<pre><code class="language-plaintext">- parameters.addParam(KeyParameter.EE_ALIAS.name(), "");
- parameters.addParam(KeyParameter.EE_ID.name(), "evil payload");
</code></pre>

That get passed to:
<pre><code class="language-java">return executeOperationForPhase(parameters, PhaseName.PREPARE_VC_GENERATION, true, null, null);</code></pre> 
<br />

Which redirects to sequentialExecutor.execute:
<pre><code class="language-java">private ResponseEntity<OperationResult> executeOperationForPhase(Parameters parameters, PhaseName phaseName, boolean failOnEmptyCommandsForPhase, SdmSecureLogEvent secureLogEvent, String electionEventId) {
    try {
        List<String> commandsForPhase = getCommands(phaseName);

        if (failOnEmptyCommandsForPhase && commandsForPhase.isEmpty()) {
            logSecure(secureLogEvent, electionEventId,
                "The request can not be performed for 4005, Missing commands for phase");

            return handleException(OperationsOutputCode.MISSING_COMMANDS_FOR_PHASE);
        }
        ExecutionListenerImpl listener = new ExecutionListenerImpl();
        sequentialExecutor.execute(commandsForPhase, parameters, listener);
</code></pre>

Which then executes our command and leaves us with control over the application.




    <br />
    <br />

    
    <h2>Timeline</h2>
    <div class="w-700 mw-full">
        <div class="card p-0 bg-very-dark-dm"> 
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <td><b>Date</b></td>
                            <td><b>Event</b></td>
                        </tr>
                    </thead>
                    <tbody>
                        
                        <tr>
                            <td>
                                February 08 2020
                            </td>
                            <td>
                                Submitted vulnerability to vendor
                            </td>                        
                        </tr>
                        
                        <tr>
                            <td>
                                February 09 2020
                            </td>
                            <td>
                                Submitted additional details to vendor
                            </td>                        
                        </tr>
                        
                        <tr>
                            <td>
                                February 18 2020
                            </td>
                            <td>
                                Vendor acknowledged the vulnerability
                            </td>                        
                        </tr>
                        
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    

    
    <h2>Credits</h2>
    <div class="w-400 mw-full">
        <div class="card p-0 bg-very-dark-dm"> 
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <td><b>Name</b></td>
                            <td><b>Team</b></td>
                        </tr>
                    </thead>
                    <tbody>
                        
                        <tr>
                            <td>
                                Anthony Schneiter
                            </td>
                            <td>
                                SUID
                            </td>                        
                        </tr>
                        
                        <tr>
                            <td>
                                Jannis Kirschner
                            </td>
                            <td>
                                SUID
                            </td>                        
                        </tr>
                        
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    



    


    <script>hljs.highlightAll();</script>
    <br />
    <br />
</div>
                </div>
            </div>
            <nav class="navbar navbar-fixed-bottom">
                <div class="navbar-content">
                    <a href="https://twitter.com/_setuid0_"><i class="twitter icon" style="color:white;"></i></a>
                    <a href="https://github.com/setuid0-sec"><i class="github icon" style="color:white;"></i></a>
                </div>
                <a href="#" class="navbar-brand ml-auto" style="font-size:14px; font-weight:normal;"> 
                    setuid(0); Research Team
                </a>
                <span class="navbar-text ml-auto">
                    &copy; setuid(0);
                </span>
                </nav>
        </div>

        <script src="/static/js/halfmoon.min.js"></script>
        <script>
            halfmoon.toggleDarkMode();
        </script>

        <style type="text/css">

            .content-wrapper {
                background-color: rgba(37, 40, 44, 0.9);
            }

            .page-wrapper {
                background-image: url('/static/img/background.gif');
            }

        </style>  

    </body>
</html>